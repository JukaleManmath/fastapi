# Alembic Migrations with SQLAlchemy (FastAPI + PostgreSQL)

This document explains:

* Why Alembic migrations are better than direct table creation
* How to set them up in a SQLAlchemy + FastAPI + PostgreSQL project
* How to use them to manage your schema cleanly

---

## ğŸš€ Why Use Alembic Migrations Instead of `Base.metadata.create_all()`?

### ğŸ” Current (Without Alembic)

You likely use:

```python
Base.metadata.create_all(bind=engine)
```

This creates all tables in your database directly at runtime.

### âŒ Limitations Without Alembic

| Problem              | Why It's an Issue                                   |
| -------------------- | --------------------------------------------------- |
| No history           | Schema changes are not tracked                      |
| No rollback          | You can't undo a migration safely                   |
| No diff detection    | Changing a model doesnâ€™t update DB automatically    |
| Not production-safe  | Manual scripts are error-prone and not reproducible |
| Environment mismatch | Dev and prod schemas can easily drift               |

### âœ… Benefits of Using Alembic Migrations

| Feature           | Advantage                                        |
| ----------------- | ------------------------------------------------ |
| Schema versioning | Tracks every change in `alembic/versions`        |
| Auto-diff         | Detects changes from model updates automatically |
| Rollback support  | Use `alembic downgrade` to undo changes          |
| Safer deployment  | Migrations can be run in CI/CD or staging        |
| Collaboration     | Keeps schema changes consistent across the team  |

---

## ğŸ› ï¸ How to Add Alembic to a SQLAlchemy Project

### 1. ğŸ“¦ Install Alembic

```bash
pip install alembic
```

### 2. ğŸ—ï¸ Initialize Alembic

```bash
alembic init alembic
```

Creates:

```
alembic/
â”œâ”€â”€ env.py
â”œâ”€â”€ script.py.mako
â””â”€â”€ versions/
alembic.ini
```

### 3. ğŸ§  Configure Alembic Metadata

Edit `alembic/env.py`:

```python
from app.models import Base

target_metadata = Base.metadata
```

Also update the `DATABASE_URL` in `alembic.ini`:

```ini
sqlalchemy.url = postgresql://user:password@localhost:5432/yourdb
```

### 4. ğŸ” Create Your First Migration

```bash
alembic revision --autogenerate -m "initial schema"
```

This inspects your models and generates a migration in `alembic/versions`.

### 5. ğŸš€ Apply the Migration

```bash
alembic upgrade head
```

This applies the changes to your PostgreSQL database.

---

## ğŸ“Œ How to Use Alembic in Day-to-Day Dev

### ğŸ” When You Change a Model (add column, table, etc.)

1. Update `models.py`
2. Run:

```bash
alembic revision --autogenerate -m "add new field to Post"
```

3. Apply it:

```bash
alembic upgrade head
```

### ğŸ”ƒ To Roll Back a Migration

```bash
alembic downgrade -1
```

Use this if a migration introduces a problem and you want to revert.

### ğŸ§¼ Best Practices

* Commit `alembic/versions` to version control
* Only one developer should create a given migration
* Review autogenerated code before applying
* Never manually edit the database in production

---

## ğŸ§  Summary

| Task                  | Without Alembic              | With Alembic                   |
| --------------------- | ---------------------------- | ------------------------------ |
| Create tables         | `.create_all()`              | `alembic upgrade head`         |
| Add column            | Manual SQL or recreate table | `alembic revision` â†’ `upgrade` |
| Track schema history  | âŒ None                       | âœ… In `alembic/versions`        |
| Revert schema change  | âŒ Not possible               | âœ… `alembic downgrade`          |
| CI/CD safe migrations | âŒ No                         | âœ… Yes                          |

Use Alembic for any real-world app to make your schema stable, trackable, and production-safe.

Let me know if youâ€™d like to scaffold a working project or apply your first migration!
